# Cookbook:: jboss
# Recipe:: default
#
# Copyright:: 2017, The Authors, All Rights Reserved.

#include_recipe 'java'

user node['jboss']['jb_user'] do
  gid node['jboss']['jb_group']
#  manage_home true
  home "#{node['jboss']['jboss_home']}" 
  system true
  shell '/bin/bash'
  action :create
end

remote_file "#{node['jboss']['install_folder']}/#{node['jboss']['jb_dist_name']}" do
  source node['jboss']['jb_repo']
  owner node[:jboss][:jboss_user]
  group node[:jboss][:jboss_group]
  action :create_if_missing
  mode '0755'
end

remote_file "#{node['jboss']['install_folder']}/#{node['jboss']['app_dist_name']}" do
  source node['jboss']['app_repo']
  owner node[:jboss][:jboss_user]
  group node[:jboss][:jboss_group]
  action :create_if_missing
  mode '0755'
end

yum_package 'unzip' do
  action :install
end

#user node['jboss']['jb_user'] do
#  home node['jboss']['jboss_home']
#  manage_home true
#  system true
#  shell '/bin/bash'
#  action :create
#end


execute 'unzip_jboss' do
  cwd node['jboss']['install_folder']
  command "unzip #{node[:jboss][:jb_dist_name]}"
#  owner node[:jboss][:jb_user]
#  group node[:jboss][:jb_group]
  not_if { ::File.directory?("#{node[:jboss][:jboss_home]}")}
end

#node['jboss']['jboss_home'] do 
#  directory dir do
#    owner "#{node['jboss']['jb_user']}"
#    group "#{node['jboss']['jb_group']}"
#  end
#end

#execute 'create user' do
#  command "useradd --system #{node[:jboss][:jb_user]} --create-home #{node[:jboss][:jboss_home]}"
#end

#user node['jboss']['jb_user'] do
#  home node['jboss']['jboss_home']
#  manage_home true
#  system true
#  shell '/bin/bash'
#  action :modify
#end

execute 'unzip_test_app' do
  cwd node['jboss']['install_folder']
#  user node['jboss']['jb_user']
#  group node['jboss']['jb_group']
  command "unzip -o #{node[:jboss][:app_dist_name]} -d #{node[:jboss][:app_deploy_folder]}"
  not_if { ::File.exist?("#{node[:jboss][:app_deploy_folder]}/testweb")}
end

template "/etc/init.d/jboss" do
  source "jboss_init_script.erb"
  owner "#{node[:jboss][:jb_user]}"
  group "#{node[:jboss][:jb_group]}"
  mode '0755'
  variables({
    :home => node[:jboss][:jboss_home],
    :ip => node[:jboss][:jboss_ip],
    :user => node[:jboss][:jb_user]
})
end

service "jboss" do
  action [:enable, :start]
  supports :start => true, :stop => true, :status => false, :reload => true
#  action [:enable, :start]
end

